@page "/admin/client-config"

@using MudBlazor
@using ScrumMaster.Models

<MudContainer>
    <MudStack Spacing="2" Class="pa-4">
        <MudStack>
           <MudText Typo="Typo.h4" Color="Color.Primary">Client Profiles</MudText>
           <MudText Typo="Typo.subtitle1">Manage client details and settings.</MudText>
        </MudStack>
        <MudStack>
        <MudIconButton Class="add-btn" Size="Size.Small" Style="width:50px;" Color="Color.Primary" Variant="Variant.Filled" 
                       Icon="@Icons.Material.Rounded.Add" OnClick="AddClientAsync" />
        </MudStack>
        <!-- Main clients table -->
        <MudTable Items="@m_clients" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh Class="pa-0 ma-0"></MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Code</MudTh>
                <MudTh>Active</MudTh>
                <MudTh>Notes</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>

            <RowTemplate Context="client">
                <MudTh Class="pa-0 ma-0 pl-2 ">
                    @if (client.Projects?.Any() == true)
                    {

                        <MudTooltip Text="Show / Hide Project">
                            <MudIconButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary" Icon="@Icons.Material.Rounded.ArrowDropDown"
                                           OnClick="@(() => ToggleProjects(client.Id))" />
                        </MudTooltip>
                                          
                    }

                </MudTh>
                <MudTd>@client.Name</MudTd>
                <MudTd>@client.Code</MudTd>
                <MudTd>
                    <MudChip T="string"
                             Color="@(@client.IsActive ? Color.Success : Color.Error)"
                             Variant="Variant.Filled">
                        @(@client.IsActive ? "Yes" : "No")
                    </MudChip>
                </MudTd>
                <MudTd>@client.Notes</MudTd>
                <MudTd>
                    <MudTooltip Text="@("Edit " + @client.Name)">
                       <MudIconButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary" Icon="@Icons.Material.Rounded.Edit"
                                      OnClick="@(() => EditClientAsync(client))" />
                    </MudTooltip>
                    <MudTooltip Text="@("Delete " + @client.Name)">
                       <MudIconButton Variant="Variant.Text" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Rounded.Delete"
                                  OnClick="@(() => DeleteClientAsync(client))" />
                    </MudTooltip>
                    <MudTooltip Text="Add Project">
                       <MudIconButton Variant="Variant.Text" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Rounded.AddTask"
                                  OnClick="@(() => AddProjectAsync(client))" />
                    </MudTooltip>                   
                </MudTd>
            </RowTemplate>

            <ChildRowContent Context="client">
                <!-- Expanded child table for projects under each client -->
                @if (m_ExpandedClients.Contains(client.Id) && client.Projects?.Any() == true)
                {
                    <MudPaper Class="pa-3 my-2" Elevation="1">
                        <MudTable Items="@client.Projects" Dense="true" Hover="true" Striped="true">
                            <HeaderContent>
                                <!-- Project table headers -->
                                <MudTh>Project Name</MudTh>
                                <MudTh>Description</MudTh>
                                <MudTh>Team Size</MudTh>
                                <MudTh>Start Date</MudTh>
                                <MudTh>End Date</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>

                            <RowTemplate Context="project">
                                <!-- Project row data -->
                                <MudTd>@project.Name</MudTd>
                                <MudTd>@project.Description</MudTd>
                                <MudTd>@project.DefaultTeamSize</MudTd>
                                <MudTd>@project.StartDate?.ToShortDateString()</MudTd>
                                <MudTd>@(project.EndDate?.ToShortDateString() ?? "-")</MudTd>
                                <MudTd>
                                    <!-- Project action buttons: Edit, Delete -->
                                    <MudButton Variant="Variant.Text" Color="Color.Primary"
                                               OnClick="@(() => EditProjectAsync(project))">Edit</MudButton>

                                    <MudButton Variant="Variant.Text" Color="Color.Error"
                                               OnClick="@(() => DeleteProjectAsync(project))">Delete</MudButton>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                }
            </ChildRowContent>

            <!-- Pager for navigating client list -->
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    </MudStack>
</MudContainer>
